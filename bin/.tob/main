main () {
    test -n "$TOBLIB" || error -x 102 "TOBLIB is not set"
    declare path= object= method= 
    declare -a opts=() args=() types=() mpaths=() apaths=() attr=()
    while test "${1:0:1}" = -; do # process option...
        case $1 in
            -q | --quiet)       QUIET=1;        opts+=(-q) ;;
            -v | --verbose)     VERBOSE=1;      opts+=(-v) ;;
            -d | --debug)       DEBUG=1;        opts+=(-d) ;;
            -h | --help)        exec awk '/^NAME$/,0' $0 ;;
            -a | --arg)         args+=($2) && shift ;;
            -m | --method)      method="$2" && shift
                                test -n "$method" ||
                                    error -x 101 "no method argument" ;;
            *) error -x 102 "unsupported option: $1" ;;
        esac
        shift
    done
    
    test -n "$method" && method_option "$@"  # ... will not return!
    test ${#args[*]} -eq 0 ||
        error -x 102 "--arg option used without --method option"

    test -n "$DEBUG" || alias debug=\#

    test -n "$1" || error -x 103 "no object specified"
    
    declare qry=$1 && shift # expecting: OBJECT.METHOD

    # if no dot found, exec as self.method, where self is current dir
    test ${qry#.} = $qry &&
        exec $0 "${opts[@]}" ..$qry "$@"

    declare -x TOB_caller_path=$PWD

    resolve_query $qry || exit

    debug "path: $path" "object: $object" "method: $method" "args: $*"
    debug "type: ${type[*]}"
   
exit 118
    
    debug "TOB_path_to_object: $TOB_path_to_object"
    
    # resolve_search_paths() builds arrays: types and paths, recursing on mixins
    # - first of 2 args is the object, not class, may include mixins
    # - types array is 1:1 with path after skipping paths[0]
    if test -n "${attr[*]}"; then
        unset attr[0]   # this is type, any other entries are envars
        resolve_search_paths $type
        object=$TOB_path_to_object
    else
        unset attr[0]   # this is type, any other entries are envars
        resolve_search_paths . $type
    fi

    debug "${#types[*]} TYPES=$types ..."
    debug "${#mpaths[*]} MPATH=$mpaths ..."
    debug "${#apaths[*]} APATH=$apaths ..."
    
    test -n "$types" || {
        test "${#apaths[@]}" -gt 1 &&
            error -x 120 "prototype but no type resolved for $object"
        error -x 121 "no type or prototype resolved for $object"
        }

    debug "top types=<$types>, ${#types[*]} entries"
    debug "top mpaths=<$mpaths>, ${#mpaths[*]} entries"
    debug "top apaths=<$apaths>, ${#apaths[*]} entries"
    
    test "$types" || {
        test "${#apaths[@]}" -gt 1 &&
            error -x 120 "prototype but no type resolved for $object"
        error -x 121 "no type or prototype resolved for $object"
        }

    ## export thinobject variables
    export TOB_object=$object
    export TOB_method=$method
    export TOB_type=$type
    export TOB_class_path
    export TOB_caller_path
    export TOB_caller_path_to_object=$TOB_path_to_object
    
    ## export thinobject utility functions and associated variables:
    export -f TOB_resolve_method_path
    export TOB_method_path
    export -f TOB_get_attr
    
    # create pseudo-arrays for export, with colon as delimiter:
    save_IFS="$IFS"
    IFS=:
    export TOB_search_paths="${apaths[*]}"
    export TOB_method_paths="${mpaths[*]}"
    export TOB_type="${types[*]}"
    IFS="$save_IFS"
    
    debug "TOB_type: $TOB_type"
    debug "TOB_search_paths: $TOB_search_paths"
    debug "TOB_method_paths: $TOB_method_paths"
    
    for envar in "${attr[@]}"; do
        tag=${envar%%=*}
        test $tag = $envar && continue
        val=${envar#*=}
        export $tag=$val
    done
    
    resolve_method_path $TOB_method &&
        exec $TOB_method_path "${args[@]}" "$@"
    
    ## no executable method was resolved, so try some built-ins:
    
    test $TOB_method = path && {
        test -z "$*" && echo $TOB_path_to_object/
        for arg in $*; do
            test -e $arg ||
                error -x 121 "$arg not found"
            echo $TOB_path_to_object/$arg
        done
        exit
        }
    
    test "$TOB_method" = "type" &&
        echo $TOB_type &&
            exit
    
    ## no method was found, so check for _default method...
    
    for path in ${mpaths[@]}; do
        ## ASSERT: class exists
        test -e $path/_default && {
            test -x $path/_default && {
                debug "tob: exec $path/_default $TOB_object $TOB_method $*"
                exec $path/_default $TOB_method "$@"
                }
            ## ASSERT: _default exists but is not executable
            ## maybe it can contain a recipe to be executed?
            error -x 122 "non-executable _default method found"
            }
    done
    
    error -x 123 "no method $TOB_method found"
    } # end main()
